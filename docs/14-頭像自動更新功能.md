# é ­åƒè‡ªå‹•æ›´æ–°åŠŸèƒ½å¯¦ä½œæŒ‡å—

## åŠŸèƒ½æ¦‚è¿°

ç•¶ç”¨æˆ¶çš„ LINE é ­åƒ URL éæœŸï¼ˆ404ï¼‰æ™‚ï¼Œå‰ç«¯æœƒè‡ªå‹•åµæ¸¬ä¸¦å¯é¸æ“‡æ€§åœ°å‘¼å«å¾Œç«¯ API é‡æ–°ç²å–æœ€æ–°çš„é ­åƒã€‚

## å‰ç«¯å¯¦ä½œ âœ… (å·²å®Œæˆ)

### 1. `useAvatar.js` Composable
- âœ… åµæ¸¬åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼ˆ404ï¼‰
- âœ… è‡ªå‹•åˆ‡æ›åˆ°é è¨­åœ–ç¤º
- âœ… å¿«å–å¤±æ•ˆçš„ URL é¿å…é‡è¤‡å˜—è©¦
- âœ… æ”¯æ´éŸ¿æ‡‰å¼æ›´æ–°

### 2. å…ƒä»¶æ›´æ–°
- âœ… `CustomerItem.vue` - å®¢æˆ¶åˆ—è¡¨é …ç›®
- âœ… `BasicInfo.vue` - CRM åŸºæœ¬è³‡è¨Š
- âœ… `MessageThread.vue` - è¨Šæ¯æ¨™é¡Œåˆ—

### 3. Profile æœå‹™
- âœ… `profileService.js` - æä¾› API ä»‹é¢ï¼ˆå¾…å¾Œç«¯å¯¦ä½œï¼‰

## ä½¿ç”¨æ–¹å¼

### åœ¨å…ƒä»¶ä¸­ä½¿ç”¨

\`\`\`vue
<script setup>
import { computed } from 'vue'
import { useAvatar } from '@/composables/useAvatar'

const props = defineProps({
  customer: Object
})

// ä½¿ç”¨ composable
const { avatarSrc, onError, onLoad, isFailed } = useAvatar(
  computed(() => props.customer.picture_url)
)
</script>

<template>
  <!-- ä½¿ç”¨ img æ¨™ç±¤è€Œé el-avatar ä»¥æ”¯æ´ error äº‹ä»¶ -->
  <img 
    v-if="avatarSrc" 
    :src="avatarSrc" 
    @error="onError"
    @load="onLoad"
    class="avatar-img"
    alt="ç”¨æˆ¶é ­åƒ"
  />
  
  <!-- è¼‰å…¥å¤±æ•—æ™‚çš„å¾Œå‚™æ–¹æ¡ˆ -->
  <el-avatar v-else :size="48">
    <el-icon><User /></el-icon>
  </el-avatar>
</template>
\`\`\`

## å¾Œç«¯ API éœ€æ±‚ (å¾…å¯¦ä½œ)

### ç«¯é»: `POST /api/users/:userId/refresh-profile`

#### åŠŸèƒ½
1. æ¥æ”¶ç”¨æˆ¶ ID
2. ä½¿ç”¨ LINE Profile API ç²å–æœ€æ–°è³‡æ–™
3. æ›´æ–° Supabase è³‡æ–™åº«
4. è¿”å›æ›´æ–°å¾Œçš„ç”¨æˆ¶è³‡æ–™

#### å¯¦ä½œç¯„ä¾‹ (Node.js + Express)

\`\`\`javascript
const line = require('@line/bot-sdk');
const { createClient } = require('@supabase/supabase-js');

const lineClient = new line.Client({
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN
});

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_KEY
);

app.post('/api/users/:userId/refresh-profile', async (req, res) => {
  try {
    const { userId } = req.params;
    
    // 1. å¾è³‡æ–™åº«ç²å–ç”¨æˆ¶çš„ line_user_id
    const { data: user, error: fetchError } = await supabase
      .from('users')
      .select('line_user_id')
      .eq('id', userId)
      .single();
    
    if (fetchError) {
      return res.status(404).json({ error: 'ç”¨æˆ¶ä¸å­˜åœ¨' });
    }
    
    // 2. å‘¼å« LINE Profile API
    const profile = await lineClient.getProfile(user.line_user_id);
    
    // 3. æ›´æ–°è³‡æ–™åº«
    const { data: updatedUser, error: updateError } = await supabase
      .from('users')
      .update({
        display_name: profile.displayName,
        picture_url: profile.pictureUrl,
        status_message: profile.statusMessage,
        updated_at: new Date().toISOString()
      })
      .eq('id', userId)
      .select()
      .single();
    
    if (updateError) {
      throw updateError;
    }
    
    // 4. è¿”å›æ›´æ–°å¾Œçš„è³‡æ–™
    res.json({
      success: true,
      user: updatedUser
    });
    
  } catch (error) {
    console.error('åˆ·æ–° Profile å¤±æ•—:', error);
    
    if (error.statusCode === 404) {
      // ç”¨æˆ¶å·²å°é–æˆ–åˆªé™¤ LINE å¸³è™Ÿ
      res.status(404).json({ 
        error: 'ç„¡æ³•ç²å–ç”¨æˆ¶è³‡æ–™ï¼Œå¯èƒ½å·²å°é–æ©Ÿå™¨äºº' 
      });
    } else {
      res.status(500).json({ 
        error: 'åˆ·æ–°å¤±æ•—',
        message: error.message 
      });
    }
  }
});
\`\`\`

### éŒ¯èª¤è™•ç†

| HTTP ç‹€æ…‹ç¢¼ | èªªæ˜ |
|------------|------|
| 200 | æˆåŠŸæ›´æ–° |
| 404 | ç”¨æˆ¶ä¸å­˜åœ¨æˆ–å·²å°é–æ©Ÿå™¨äºº |
| 500 | ä¼ºæœå™¨éŒ¯èª¤ |

## å‰ç«¯å‘¼å«æ–¹å¼

### æ‰‹å‹•åˆ·æ–°å–®å€‹ç”¨æˆ¶

\`\`\`javascript
import { refreshUserProfile } from '@/utils/profileService'

async function handleRefreshAvatar(userId) {
  try {
    const updatedUser = await refreshUserProfile(userId)
    console.log('é ­åƒå·²æ›´æ–°:', updatedUser.picture_url)
    
    // é‡æ–°è¼‰å…¥ç”¨æˆ¶è³‡æ–™
    await customersStore.fetchCustomers()
  } catch (error) {
    console.error('åˆ·æ–°å¤±æ•—:', error)
    ElMessage.error('ç„¡æ³•æ›´æ–°é ­åƒ')
  }
}
\`\`\`

### æ‰¹æ¬¡åˆ·æ–°ï¼ˆå®šæœŸä»»å‹™ï¼‰

\`\`\`javascript
import { batchRefreshProfiles } from '@/utils/profileService'

async function refreshAllFailedAvatars() {
  // ç²å–æ‰€æœ‰é ­åƒè¼‰å…¥å¤±æ•—çš„ç”¨æˆ¶ ID
  const failedUserIds = [1, 2, 3, 4, 5]
  
  const results = await batchRefreshProfiles(failedUserIds)
  
  console.log(\`æˆåŠŸ: \${results.success.length}\`)
  console.log(\`å¤±æ•—: \${results.failed.length}\`)
}
\`\`\`

## ç’°å¢ƒè®Šæ•¸

éœ€è¦åœ¨ `.env` ä¸­è¨­å®šï¼š

\`\`\`env
# å¾Œç«¯ API URL
VITE_BACKEND_URL=https://line-message-collector.onrender.com

# LINE Bot æ†‘è­‰ï¼ˆå¾Œç«¯ä½¿ç”¨ï¼‰
LINE_CHANNEL_ACCESS_TOKEN=your_access_token
LINE_CHANNEL_SECRET=your_channel_secret
\`\`\`

## é€²éšåŠŸèƒ½ï¼ˆå¯é¸ï¼‰

### 1. è‡ªå‹•å®šæœŸåˆ·æ–°
åœ¨å¾Œç«¯è¨­ç½® Cron Jobï¼Œæ¯å¤©æª¢æŸ¥ä¸¦æ›´æ–°éæœŸçš„é ­åƒï¼š

\`\`\`javascript
// æ¯å¤©å‡Œæ™¨ 3 é»åŸ·è¡Œ
cron.schedule('0 3 * * *', async () => {
  console.log('é–‹å§‹æ‰¹æ¬¡æ›´æ–°é ­åƒ...');
  
  const { data: users } = await supabase
    .from('users')
    .select('id, line_user_id')
    .eq('is_active', true);
  
  for (const user of users) {
    try {
      const profile = await lineClient.getProfile(user.line_user_id);
      await supabase
        .from('users')
        .update({ picture_url: profile.pictureUrl })
        .eq('id', user.id);
    } catch (error) {
      console.error(\`ç”¨æˆ¶ \${user.id} æ›´æ–°å¤±æ•—:\`, error.message);
    }
  }
});
\`\`\`

### 2. Webhook è‡ªå‹•æ›´æ–°
ç•¶æ”¶åˆ° LINE Webhook äº‹ä»¶æ™‚ï¼Œè‡ªå‹•æ›´æ–°ç”¨æˆ¶è³‡æ–™ï¼š

\`\`\`javascript
app.post('/webhook', async (req, res) => {
  const events = req.body.events;
  
  for (const event of events) {
    if (event.type === 'message') {
      // æ”¶åˆ°è¨Šæ¯æ™‚é †ä¾¿æ›´æ–° Profile
      const profile = await lineClient.getProfile(event.source.userId);
      
      await supabase
        .from('users')
        .update({
          display_name: profile.displayName,
          picture_url: profile.pictureUrl
        })
        .eq('line_user_id', event.source.userId);
    }
  }
  
  res.sendStatus(200);
});
\`\`\`

## æ¸¬è©¦

### 1. æ¸¬è©¦é ­åƒéæœŸåµæ¸¬

åœ¨ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ä¸­æ¨¡æ“¬ 404ï¼š
1. é–‹å•Ÿ Network æ¨™ç±¤
2. å³éµé»æ“Šé ­åƒåœ–ç‰‡è«‹æ±‚
3. é¸æ“‡ "Block request URL"
4. é‡æ–°è¼‰å…¥é é¢ï¼Œæ‡‰è©²çœ‹åˆ°é è¨­åœ–ç¤º

### 2. æ¸¬è©¦ API å‘¼å«

\`\`\`javascript
// åœ¨ç€è¦½å™¨ Console åŸ·è¡Œ
import { refreshUserProfile } from '@/utils/profileService'

refreshUserProfile(1).then(console.log).catch(console.error)
\`\`\`

## æ³¨æ„äº‹é …

âš ï¸ **é‡è¦é™åˆ¶**ï¼š
1. LINE Profile API åªåœ¨ç”¨æˆ¶**æœªå°é–**æ©Ÿå™¨äººæ™‚æœ‰æ•ˆ
2. ç”¨æˆ¶åˆªé™¤ LINE å¸³è™Ÿå¾Œç„¡æ³•ç²å–è³‡æ–™
3. é »ç¹å‘¼å« API å¯èƒ½è§¸ç™¼ LINE çš„é€Ÿç‡é™åˆ¶

ğŸ’¡ **å»ºè­°**ï¼š
- ä½¿ç”¨å¿«å–é¿å…é‡è¤‡æª¢æ¸¬åŒä¸€å€‹å¤±æ•ˆ URL
- å®šæœŸæ‰¹æ¬¡æ›´æ–°è€Œéå³æ™‚æ›´æ–°
- è¨˜éŒ„å¤±æ•—çš„æ›´æ–°ä»¥ä¾¿å¾ŒçºŒè™•ç†

## ç›¸é—œæ–‡ä»¶

- `src/composables/useAvatar.js` - é ­åƒè™•ç†é‚è¼¯
- `src/utils/profileService.js` - API æœå‹™ä»‹é¢
- `docs/12-LINE_Profile_APIåˆ†æ.md` - LINE API è©³ç´°èªªæ˜
