# 客戶主檔維護功能說明

## 📋 功能概述

客戶主檔維護頁面提供集中管理所有客戶 ERP 資料的功能，包含搜尋、編輯、排序、分頁和匯出等完整功能。

**路由位置**: `/customer-master`

## ✨ 主要功能

### 1. 統計儀表板
- **總客戶數**: 顯示系統中所有客戶數量
- **已建檔**: 已填寫 ERP 資料的客戶數
- **未建檔**: 尚未填寫 ERP 資料的客戶數
- **建檔率**: 已建檔客戶的百分比，附帶進度條視覺化

### 2. 搜尋與篩選
- 支援以下欄位的模糊搜尋：
  - LINE 名稱 (`display_name`)
  - LINE User ID (`line_user_id`)
  - ERP 客戶編號 (`erp_bi_code`)
  - ERP 客戶名稱 (`erp_bi_name`)
- 即時搜尋，輸入後立即顯示結果
- 可清除篩選條件返回完整列表

### 3. 表格顯示

#### 顯示欄位
| 欄位 | 說明 | 功能 |
|------|------|------|
| 序號 | 自動編號，跟隨分頁 | - |
| LINE 客戶 | 頭像 + LINE 名稱 + LINE ID | 支援排序 |
| ERP 客戶編號 | 可編輯 | 點擊即改，支援排序 |
| ERP 客戶名稱 | 可編輯 | 點擊即改，支援排序 |
| 建檔狀態 | 已建檔/未建檔標籤 | - |
| 訊息數 | 該客戶的訊息總數 | 支援排序 |
| 最後更新 | 最後更新時間 | 支援排序 |
| 操作 | 清除 ERP 資料按鈕 | - |

#### 行內編輯功能
1. **啟動編輯**：點擊 ERP 編號或名稱儲存格
2. **儲存方式**：
   - 按 Enter 鍵儲存
   - 點擊其他地方（失焦）自動儲存
   - 按 Esc 鍵取消編輯
3. **視覺回饋**：
   - 游標懸停顯示編輯圖示
   - 編輯時顯示輸入框
   - 儲存成功顯示提示訊息

### 4. 排序功能
- 點擊表格標題進行排序
- 支援升冪/降冪切換
- 可排序欄位：
  - LINE 名稱
  - ERP 客戶編號
  - ERP 客戶名稱
  - 訊息數量
  - 最後更新時間

### 5. 分頁功能
- 可選擇每頁顯示筆數：10/20/50/100
- 支援頁碼跳轉
- 搜尋和排序時自動重置到第一頁

### 6. CSV 匯出
- 匯出所有已篩選的客戶資料
- 匯出內容包含：
  - ID
  - LINE User ID
  - LINE 名稱
  - ERP 客戶編號
  - ERP 客戶名稱
  - 訊息數量
  - 最後更新時間
  - 建立時間
  - 最後訊息時間
- 檔案格式：`客戶主檔_YYYY-MM-DD.csv`
- 自動加入 UTF-8 BOM，Excel 可直接開啟

### 7. 其他功能
- **重新載入**：重新從資料庫載入最新資料
- **清除 ERP 資料**：單筆刪除客戶的 ERP 資訊
- **響應式設計**：支援行動裝置瀏覽

## 🎯 使用場景

### 場景 1：批量建立客戶主檔
1. 開啟客戶主檔頁面
2. 檢視「未建檔」客戶數量
3. 依序點擊 ERP 編號和名稱欄位填寫資料
4. 完成後查看建檔率提升

### 場景 2：搜尋特定客戶
1. 在搜尋框輸入關鍵字（例如：客戶名稱或編號）
2. 系統即時顯示符合的客戶
3. 點擊編輯所需欄位

### 場景 3：匯出客戶清單
1. 使用搜尋功能篩選（可選）
2. 點擊「匯出 CSV」按鈕
3. 確認匯出數量
4. 檔案自動下載到本地

### 場景 4：資料維護
1. 使用搜尋找到需要修改的客戶
2. 點擊欄位進行編輯
3. Enter 或失焦自動儲存
4. 錯誤資料可用「清除」按鈕移除

## 🔧 技術架構

### 前端元件
```
src/views/CustomerMaster.vue          # 主頁面
  └── src/components/customer/
      └── CustomerMasterTable.vue     # 表格元件
```

### 狀態管理
```
src/stores/customerMaster.js          # Pinia Store
  ├── fetchAllCustomers()             # 載入客戶
  ├── updateCustomerErp()             # 更新 ERP
  ├── setSearchKeyword()              # 設定搜尋
  ├── setSorting()                    # 設定排序
  ├── setCurrentPage()                # 設定頁碼
  ├── setPageSize()                   # 設定每頁筆數
  └── downloadCSV()                   # 下載 CSV
```

### 工具函數
```
src/utils/csvExport.js                # CSV 匯出工具
  ├── arrayToCSV()                    # 陣列轉 CSV
  ├── downloadCSV()                   # 下載 CSV
  ├── formatCSVCell()                 # 格式化儲存格
  └── formatCSVDateTime()             # 格式化日期
```

## 📊 資料庫欄位

使用 `users` 表的以下欄位：

| 欄位 | 型別 | 說明 |
|------|------|------|
| `id` | INTEGER | 主鍵 |
| `line_user_id` | TEXT | LINE 用戶 ID |
| `display_name` | TEXT | LINE 名稱 |
| `picture_url` | TEXT | 頭像 URL |
| `erp_bi_code` | TEXT | ERP 客戶編號（可編輯） |
| `erp_bi_name` | TEXT | ERP 客戶名稱（可編輯） |
| `message_count` | INTEGER | 訊息數量 |
| `updated_at` | TIMESTAMP | 更新時間 |
| `created_at` | TIMESTAMP | 建立時間 |
| `last_message_at` | TIMESTAMP | 最後訊息時間 |

## 🧪 測試

### 執行測試腳本
```bash
npm run test-customer-master
```

測試項目：
- ✅ 載入客戶列表
- ✅ 搜尋功能
- ✅ 更新 ERP 資料（模擬）
- ✅ 排序功能
- ✅ 分頁功能
- ✅ CSV 匯出格式
- ✅ 資料完整性

### 手動測試清單
- [ ] 開啟 `/customer-master` 頁面
- [ ] 檢查統計卡片顯示正確
- [ ] 測試搜尋功能
- [ ] 點擊儲存格編輯 ERP 資料
- [ ] 測試排序功能
- [ ] 切換分頁和每頁筆數
- [ ] 匯出 CSV 並用 Excel 開啟
- [ ] 清除客戶 ERP 資料
- [ ] 測試響應式布局（縮小瀏覽器）

## 🎨 UI 設計特色

### 視覺效果
- 漸層色統計卡片，hover 有浮起效果
- 進度條顯示建檔率
- 已建檔/未建檔用不同顏色標籤區分
- 表格 hover 顯示編輯圖示

### 顏色系統
- **總客戶數**：紫色漸層 (#667eea → #764ba2)
- **已建檔**：綠色漸層 (#84fab0 → #8fd3f4)
- **未建檔**：橘色漸層 (#ffecd2 → #fcb69f)
- **建檔率**：藍色漸層 (#a1c4fd → #c2e9fb)

### 互動反饋
- 載入狀態顯示 loading 動畫
- 操作成功/失敗顯示提示訊息
- 危險操作（清除）有確認對話框

## 📱 響應式設計

### 桌面版 (>768px)
- 四欄統計卡片
- 完整表格顯示
- 橫向導航選單

### 行動版 (≤768px)
- 單欄統計卡片
- 隱藏導航選單
- 按鈕文字簡化

## 🔐 權限與安全

- 所有更新操作通過 Supabase RLS 驗證
- 不允許直接刪除客戶資料，僅清空 ERP 欄位
- CSV 匯出不包含敏感資料（如 status_message）

## 📝 注意事項

1. **資料一致性**：編輯後會自動更新 `updated_at` 時間戳
2. **搜尋效能**：大量資料時搜尋在前端執行，響應即時
3. **CSV 編碼**：使用 UTF-8 BOM 確保 Excel 正確顯示中文
4. **排序邏輯**：空值會排在最後
5. **分頁記憶**：切換路由後分頁狀態會重置

## 🚀 後續擴充建議

- [ ] 批量匯入 ERP 資料（CSV 上傳）
- [ ] 批量編輯（選取多筆客戶同時操作）
- [ ] 歷史記錄（追蹤 ERP 資料變更）
- [ ] 進階篩選（按建檔狀態、訊息數範圍等）
- [ ] 匯出格式選擇（Excel, PDF）
- [ ] 欄位自訂顯示/隱藏
- [ ] 整合 ERP 系統 API 自動比對

## 📞 相關文件

- [資料庫架構定義](../configs/database.js)
- [專案說明文件](./06-專案說明(給Claude的指引).md)
- [變更記錄](../CHANGELOG_CRM_ERP.md)
